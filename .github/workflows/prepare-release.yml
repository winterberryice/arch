name: Prepare Release

on:
  issue_comment:
    types: [created]

jobs:
  prepare-release:
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/release')
    runs-on: ubuntu-latest
    concurrency:
      group: release-process
      cancel-in-progress: false
    steps:
      - name: Check out master branch
        uses: actions/checkout@v4
        with:
          ref: 'master'
          # PAT token is required to push back to the repo
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Get PR branch
        id: get_pr_branch
        run: |
          PR_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "${{ github.event.issue.pull_request.url }}")
          BRANCH=$(echo "$PR_JSON" | jq -r .head.ref)
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Process release command and bump version
        id: process_release
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          MERGE_STRATEGY="--no-ff"
          BUMP_TYPE="patch" # Default to patch

          if [[ "$COMMENT_BODY" == *"--squash"* ]]; then
            MERGE_STRATEGY="--squash"
          fi

          if [[ "$COMMENT_BODY" == *"/release major"* ]]; then
            BUMP_TYPE="major"
          elif [[ "$COMMENT_BODY" == *"/release minor"* ]]; then
            BUMP_TYPE="minor"
          fi

          echo "merge_strategy=$MERGE_STRATEGY" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

          # Version bumping logic
          VERSION_STRING=$(cat version)
          VERSION_NO_V=${VERSION_STRING#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION_NO_V"

          if [[ "$BUMP_TYPE" == "major" ]]; then
            MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0;
          elif [[ "$BUMP_TYPE" == "minor" ]]; then
            MINOR=$((MINOR + 1)); PATCH=0;
          else
            PATCH=$((PATCH + 1));
          fi

          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "$NEW_VERSION" > version
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Merge, Commit, Tag, and Push
        run: |
          # Fetch and merge the PR branch
          git fetch origin ${{ steps.get_pr_branch.outputs.branch }}
          git merge ${{ steps.process_release.outputs.merge_strategy }} origin/${{ steps.get_pr_branch.outputs.branch }} \
            -m "feat: Merge changes from PR #${{ github.event.issue.number }}"

          # Add the version file change
          git add version

          # Create or amend the commit to produce a single, clean release commit
          COMMIT_MSG="chore(release): ${{ steps.process_release.outputs.new_version }}"
          if [[ "${{ steps.process_release.outputs.merge_strategy }}" == "--squash" ]]; then
            git commit -m "$COMMIT_MSG"
          else
            git commit --amend -m "$COMMIT_MSG"
          fi

          # Tag and push
          git tag ${{ steps.process_release.outputs.new_version }}
          git push origin master
          git push origin ${{ steps.process_release.outputs.new_version }}

      - name: Close Pull Request
        run: |
          gh pr close ${{ github.event.issue.number }} --comment "Released in ${{ steps.process_release.outputs.new_version }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
