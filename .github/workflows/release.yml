name: Release

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/release') &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'
      )
    runs-on: ubuntu-latest
    concurrency:
      group: release-process
      cancel-in-progress: false
    steps:
      - name: Check out master branch
        uses: actions/checkout@v4
        with:
          ref: 'master'
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Get PR branch and validate version
        id: get_pr_branch
        run: |
          PR_JSON=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "${{ github.event.issue.pull_request.url }}")
          BRANCH=$(echo "$PR_JSON" | jq -r .head.ref)
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

          # Validate branch name matches vX.Y.Z pattern
          if [[ ! "$BRANCH" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Branch name '$BRANCH' does not match required pattern 'vX.Y.Z' (e.g., v0.5.0). Only version branches can be released."
            exit 1
          fi

          # Extract version from branch name
          echo "version=$BRANCH" >> $GITHUB_OUTPUT

      - name: Process release command
        id: process_release
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          MERGE_STRATEGY="--rebase" # Default to rebase

          if [[ "$COMMENT_BODY" == *"--merge-commit"* ]]; then
            MERGE_STRATEGY="--no-ff"
          elif [[ "$COMMENT_BODY" == *"--squash"* ]]; then
            MERGE_STRATEGY="--squash"
          fi

          echo "merge_strategy=$MERGE_STRATEGY" >> $GITHUB_OUTPUT

      - name: Merge, Commit, Tag, and Push
        id: release_commit
        run: |
          set -e

          MERGE_STRATEGY="${{ steps.process_release.outputs.merge_strategy }}"
          BRANCH_NAME="${{ steps.get_pr_branch.outputs.branch }}"
          NEW_VERSION="${{ steps.get_pr_branch.outputs.version }}"
          PR_NUMBER="${{ github.event.issue.number }}"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          git fetch origin $BRANCH_NAME

          # Perform the merge
          if [[ "$MERGE_STRATEGY" == "--rebase" ]]; then
            git checkout $BRANCH_NAME
            git rebase origin/master
            git checkout master
            git merge --ff-only $BRANCH_NAME
          else
            git merge $MERGE_STRATEGY origin/$BRANCH_NAME -m "feat: Merge changes from PR #$PR_NUMBER"
          fi

          # Update version file from branch name
          echo "$NEW_VERSION" > version
          git add version

          # Create the final release commit
          COMMIT_MSG="chore(release): $NEW_VERSION"
          if [[ "$MERGE_STRATEGY" == "--squash" ]]; then
            git commit -m "$COMMIT_MSG"
          else
            git commit --amend -m "$COMMIT_MSG"
          fi

          git tag $NEW_VERSION
          git push origin master
          git push origin $NEW_VERSION

      - name: Close Pull Request
        run: |
          gh pr close ${{ github.event.issue.number }} --comment "Released in ${{ steps.release_commit.outputs.new_version }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_commit.outputs.new_version }}
          generate_release_notes: true
