#!/bin/bash
# BTRFS snapshot management via snapper
# Usage: wintarch-snapshot <create|list|delete> [args]

set -e

COMMAND="$1"
shift || true

if [[ -z $COMMAND ]]; then
    echo "Usage: wintarch-snapshot <create|list|delete> [args]" >&2
    echo "" >&2
    echo "Commands:" >&2
    echo "  create [description]  Create a new snapshot" >&2
    echo "  list                  List all snapshots" >&2
    echo "  delete <number>       Delete a snapshot" >&2
    exit 1
fi

# Snapper must be available
if ! command -v snapper &>/dev/null; then
    echo "Error: snapper not found. Is it installed?" >&2
    exit 1
fi

case "$COMMAND" in
    create)
        DESC="${1:-manual snapshot}"
        echo -e "\e[32mCreating system snapshot: $DESC\e[0m"

        # Get existing snapper config names
        mapfile -t CONFIGS < <(sudo snapper --csvout list-configs | awk -F, 'NR>1 {print $1}')

        for config in "${CONFIGS[@]}"; do
            sudo snapper -c "$config" create -c number -d "$DESC"
        done
        echo "Snapshot created."
        ;;
    list)
        sudo snapper -c root list
        ;;
    delete)
        if [[ -z ${1:-} ]]; then
            echo "Usage: wintarch-snapshot delete <number>" >&2
            exit 1
        fi
        sudo snapper -c root delete "$1"
        echo "Snapshot $1 deleted."
        ;;
    *)
        echo "Unknown command: $COMMAND" >&2
        exit 1
        ;;
esac
